# インフラストラクチャ設計書

## 1. システム構成概要

### 1.1 全体アーキテクチャ
```
ユーザー → CDN → Next.js (Vercel) → API Routes → Prisma ORM → Neon PostgreSQL
                       ↓
                Vercel Blob (添付ファイル保存)
```

### 1.2 使用技術
- **フロントエンド**: Next.js (v15.3.1)
- **UIライブラリ**: React (v19.1.0)
- **バックエンド**: Next.js API Routes
- **データベース**: Neon PostgreSQL (サーバーレスPostgreSQL)
- **ORM**: Prisma (v6.7.0)
- **認証**: JWT (jsonwebtoken / jose)
- **UI**: Material UI v7.1.0 (DataGrid, Chart含む)
- **状態管理**: Zustand (v5.0.4)
- **APIキャッシュ**: React Query（TanStack Query v5.75.2）
- **フォーム管理**: React Hook Form (v7.56.3)
- **バリデーション**: Zod (v3.24.4)
- **ストレージ**: Vercel Blob (添付ファイル用)
- **デプロイメント**: Vercel
- **言語**: TypeScript (v5.8.3)
- **スタイリング**: Tailwind CSS (v4.1.5)

### 1.3 システム要件
- **想定同時接続ユーザー数**: 最大100名
- **月間トラフィック**: 約50GB
- **レスポンス時間**: API応答 500ms以内
- **可用性**: 99.9%（月間ダウンタイム約43分以内）

## 2. インフラストラクチャ環境

### 2.1 本番環境
- **ホスティング**: Vercel Pro プラン (Next.js専用プラットフォーム)
- **リージョン**: Tokyo (ap-northeast-1)
- **データベース**: Neon PostgreSQL Standardプラン (マネージドサービス)
- **ストレージ**: Vercel Blob (添付ファイル用)
- **CDN**: Vercel Edge Network
- **ドメイン管理**: Vercel Domains または外部ドメイン連携

### 2.2 開発・テスト環境
- **開発環境**: ローカル開発 + Vercel Preview Deployments
- **テスト環境**: Vercel Preview環境 + テスト用Neonデータベース
- **ステージング環境**: 本番と同構成（ただし小規模リソース）のVercel環境

### 2.3 環境分離戦略
- **ブランチ戦略**: GitHub Flow（feature → main）
- **環境変数管理**: Vercel環境ごとの変数設定
- **データ分離**: 環境ごとに独立したデータベース

## 3. データベース設計

### 3.1 データベース構成
- **種類**: Neon PostgreSQL (サーバーレスPostgreSQL)
- **スケーリング**: 自動スケーリング対応
- **バックアップ**: 日次自動バックアップ + ポイントインタイムリカバリ
- **リソース**: 初期1 Compute Unit、必要に応じて自動スケーリング
- **ストレージ**: 初期10GB、自動拡張

### 3.2 接続管理
- **コネクションプール**: PgBouncerによる接続管理（Neon標準機能）
- **認証情報**: 環境変数経由で安全に管理
- **最大接続数**: 20（調整可能）

### 3.3 データベース保守
- **スキーママイグレーション**: Prisma Migrate
- **インデックス最適化**: 四半期ごとに性能分析と最適化
- **バキューム処理**: 自動実行（Neonによる管理）

## 4. デプロイメント戦略

### 4.1 CI/CD パイプライン
- **バージョン管理**: GitHub
- **CI/CD**: GitHub Actions + Vercel自動デプロイ
- **フロー**:
  1. プルリクエスト作成時にVercel Previewデプロイ
  2. テスト自動実行（Jest + React Testing Library）
  3. コードレビュー
  4. mainブランチへのマージで本番環境に自動デプロイ

### 4.2 デプロイメント構成
- **デプロイ形式**: Serverless Functions (Vercel)
- **スケーリング**: 自動スケーリング
- **ゼロダウンタイム**: Blue-Greenデプロイメント

### 4.3 デプロイメント管理
- **ロールバック戦略**: Vercelのデプロイメント履歴から即時ロールバック
- **フィーチャーフラグ**: 開発中機能の段階的リリース対応
- **環境設定管理**: 環境変数とビルド設定をVercelプロジェクト設定で一元管理

## 5. セキュリティ対策

### 5.1 認証・認可
- **認証方式**: JWT
- **トークン管理**: Zustand store
- **トークン有効期限**: アクセストークン 15分（900秒）
- **パスワード管理**: bcryptjsによるハッシュ化
- **JWT処理**: 
  - 通常のAPI Routes: jsonwebtoken
  - Edge Runtime: jose

### 5.2 通信セキュリティ
- **HTTPSの強制**: 全通信をHTTPS化
- **CORS設定**: 適切なオリジン制限
- **コンテンツセキュリティポリシー**: 厳格なCSP設定
- **API Rate Limiting**: IPベース + ユーザーベースの制限

### 5.3 データセキュリティ
- **保存データ暗号化**: データベースの透過的暗号化
- **機密情報**: 環境変数での安全な管理
- **添付ファイル**: Vercel Blobのアクセス制限と署名付きURL

### 5.4 セキュリティ監視
- **脆弱性スキャン**: 定期的な自動スキャン
- **依存関係チェック**: npm auditによる依存パッケージの脆弱性チェック
- **エラー監視**: Vercel標準機能（必要に応じてSentry導入検討）

### 5.5 セキュリティインシデント対応
- **対応フロー**: 検知→分析→対応→報告→改善の5ステップ
- **責任者**: セキュリティ責任者の指定
- **連絡体制**: エスカレーションプロセスの明確化

## 6. 監視・ロギング

### 6.1 アプリケーション監視
- **エラー監視**: Vercel標準機能（必要に応じてSentry導入検討）
- **パフォーマンス監視**: Vercel Analytics
- **ユーザーエクスペリエンス**: Core Web Vitals追跡

### 6.2 ロギング
- **アプリケーションログ**: 構造化ログ形式
- **ログ管理**: Vercel Logsでの集中管理
- **ログレベル**: ERROR, WARN, INFO, DEBUG
- **ログ保持期間**: 30日

### 6.3 監視メトリクス
- **API応答時間**: 平均、95パーセンタイル、99パーセンタイル
- **エラーレート**: リクエスト数に対するエラー率
- **システムリソース**: CPU使用率、メモリ使用率
- **データベース**: クエリ応答時間、接続数

### 6.4 アラート
- **障害検知**: パフォーマンス閾値監視
- **通知方法**: Slack、Eメール
- **優先度**: 重大度に基づく3段階（高、中、低）
- **オンコール体制**: 運用フェーズでの対応者ローテーション計画

## 7. バックアップ・リカバリ

### 7.1 バックアップ戦略
- **データベース**: Neonの自動バックアップ (日次)
- **添付ファイル**: Vercel Blobのバックアップ機能
- **バックアップ保持期間**: 
  - 日次バックアップ: 7日間
  - 週次バックアップ: 4週間
  - 月次バックアップ: 3ヶ月

### 7.2 リストア手順
- **フルリストア**: Neonコンソールからのポイントインタイムリカバリ
- **部分リストア**: 特定テーブルのみの復元手順
- **検証**: 四半期ごとのリストアテスト実施

### 7.3 障害復旧計画
- **RTO (Recovery Time Objective)**: 2時間以内
- **RPO (Recovery Point Objective)**: 24時間以内
- **障害レベル分類**: レベル1（部分障害）〜レベル3（完全システム喪失）
- **ディザスタリカバリ**: マルチリージョン復旧計画

## 8. スケーラビリティ設計

### 8.1 水平スケーリング
- **サーバーレスアーキテクチャ**: 負荷に応じた自動スケーリング
- **データベース**: Neonの自動スケーリング機能の活用
- **スケーリングトリガー**: CPU使用率70%超、メモリ使用率80%超

### 8.2 パフォーマンスチューニング
- **データベースインデックス**: 頻繁に使用されるクエリの最適化
- **クエリ最適化**: N+1問題の解決、不必要なデータ取得の回避
- **フロントエンド最適化**: コード分割、遅延読み込み、画像最適化

### 8.3 キャッシュ戦略
- **CDN**: 静的アセットのキャッシュ
- **API**: React Query（TanStack Query）によるクライアントサイドキャッシュ
- **キャッシュ有効期間**:
  - 静的アセット: 1週間
  - API応答: 種類により5分〜1時間

### 8.4 将来的なスケーリング
- **マイクロサービス移行**: トラフィック増加時の分割戦略
- **データベースシャーディング**: 1年後の成長に備えた計画
- **CDNリージョン拡張**: グローバル展開時の検討事項

## 9. コスト最適化

### 9.1 リソース管理
- **サーバーレスアーキテクチャ**: 使用量ベースの課金
- **自動スケーリング**: 需要に応じたリソース調整
- **コールドスタート対策**: 定期的なウォームアップ

### 9.2 予測コスト
- **月間予測コスト**: 
  - Vercel Pro: $20〜40/月
  - Neon PostgreSQL: $0〜50/月（使用量による）
  - Vercel Blob: $5〜20/月（ストレージとトラフィックによる）
  - その他サービス: $10〜30/月
  - 合計: $35〜140/月

### 9.3 コスト監視
- **予算アラート**: 閾値設定によるコスト監視
- **使用量分析**: 定期的なリソース使用状況レビュー
- **最適化レビュー**: 月次のコスト最適化検討

## 10. 実装計画・スケジュール

### 10.1 フェーズ1: 基盤構築 (4週間)
- **週1**: 開発環境セットアップ
  - Vercelアカウント設定・チーム作成
  - Neon PostgreSQLデータベース作成
  - リポジトリ設定とCI/CD基盤構築
- **週2**: API基盤とセキュリティ設定
  - JWT認証システム実装（jsonwebtoken/jose）
  - 環境変数設定
  - HTTPS・CORS設定
- **週3**: ストレージ・監視設定
  - Vercel Blob設定
  - ロギング基盤構築
  - エラー監視設定
- **週4**: 初期テストと最適化
  - セキュリティテスト
  - パフォーマンス基盤チェック
  - CI/CDパイプライン検証

### 10.2 フェーズ2: 機能実装 (6週間)
- **週1-2**: コア機能デプロイ
  - ユーザー認証
  - プロジェクト管理
  - 基本的なCRUD操作
- **週3-4**: 拡張機能デプロイ
  - 質問管理
  - 回答システム
  - 通知システム
- **週5-6**: テストと監視
  - 単体テスト・統合テスト（Jest + React Testing Library）
  - E2Eテスト（Playwright/Cypress）
  - アラート設定

### 10.3 フェーズ3: 最適化・安定化 (4週間)
- **週1-2**: パフォーマンス最適化
  - React Queryによるキャッシュ実装
  - クエリ最適化
  - フロントエンド高速化
- **週3-4**: 運用準備
  - バックアップ・リストアテスト
  - マニュアル整備
  - 運用引継ぎ準備

### 10.4 リスク管理
- **潜在的リスク**:
  - サーバーレス環境のコールドスタート影響
  - データベース接続数制限
  - コスト予測の不確実性
- **対策**:
  - 定期的なウォームアップ関数の設定
  - コネクションプールの適切な設定
  - 使用量監視と早期アラート設定 