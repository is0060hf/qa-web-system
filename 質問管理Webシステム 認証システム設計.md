# 質問管理Webシステム 認証システム設計

## 1. 概要

本ドキュメントは、質問管理Webシステムの認証および認可に関する設計を定義します。ユーザーはメールアドレスとパスワードを用いて認証され、役割（ロール）に基づいてシステム機能へのアクセスが制御されます。

## 2. 認証フロー

### 2.1. ユーザー登録

1.  ユーザーは登録画面で氏名（任意）、メールアドレス、パスワードを入力します。
2.  フロントエンドは入力値を検証します（メール形式、パスワード強度など）。
3.  フロントエンドは `/api/auth/register` エンドポイントにPOSTリクエストを送信します。
4.  バックエンドはメールアドレスの重複を確認します。
5.  バックエンドはパスワードを安全なハッシュアルゴリズム（例: bcrypt, Argon2）でハッシュ化します。
6.  バックエンドは `User` テーブルに新しいユーザーレコードを作成します（デフォルトロールは `USER`）。
7.  バックエンドは成功レスポンス（ユーザー情報）を返します。

### 2.2. ログイン

1.  ユーザーはログイン画面でメールアドレスとパスワードを入力します。
2.  フロントエンドは `/api/auth/login` エンドポイントにPOSTリクエストを送信します。
3.  バックエンドは提供されたメールアドレスでユーザーを検索します。
4.  ユーザーが見つかった場合、バックエンドは提供されたパスワードとデータベースに保存されているパスワードハッシュを比較します。
5.  認証が成功した場合、バックエンドはユーザー情報（ID, email, name, role）を含むペイロードでJWT（JSON Web Token）を生成し、署名します。
6.  バックエンドはJWTとユーザー情報をレスポンスとして返します。
7.  フロントエンドはJWTを安全な場所（例: HttpOnlyクッキー、またはLocalStorage/SessionStorage - XSSリスクに注意）に保存します。
8.  以降の認証が必要なリクエストでは、フロントエンドはこのJWTを `Authorization: Bearer <token>` ヘッダーに含めて送信します。

### 2.3. ログアウト

1.  ユーザーがログアウト操作を行います。
2.  フロントエンドは保存しているJWTを削除します。
3.  （オプション）フロントエンドは `/api/auth/logout` エンドポイントを呼び出し、サーバーサイドでトークンの無効化リスト（ブラックリスト）に追加することも可能です（ステートレスなJWTの利点を一部損なうため、要件に応じて検討）。
4.  ユーザーはログイン画面にリダイレクトされます。

### 2.4. パスワードリセット

1.  **リクエスト:**
    *   ユーザーは「パスワードをお忘れですか？」リンクをクリックし、メールアドレスを入力します。
    *   フロントエンドは `/api/auth/request-password-reset` にPOSTリクエストを送信します。
    *   バックエンドは一時的なリセットトークン（有効期限付き、ランダムで推測困難な文字列）を生成し、データベースに保存（またはトークン自体に有効期限情報を含める）します。
    *   バックエンドはリセットトークンを含むURL（例: `https://your-app.com/reset-password?token=...`）を生成し、ユーザーのメールアドレス宛に送信します。
2.  **リセット実行:**
    *   ユーザーはメール内のリンクをクリックし、パスワードリセット画面にアクセスします。
    *   フロントエンドはURLからリセットトークンを取得します。
    *   ユーザーは新しいパスワードを入力します。
    *   フロントエンドは `/api/auth/reset-password` にPOSTリクエストを送信します（リセットトークンと新しいパスワードを含む）。
    *   バックエンドはリセットトークンを検証（存在確認、有効期限確認）します。
    *   トークンが有効な場合、バックエンドは新しいパスワードをハッシュ化し、該当ユーザーのパスワードハッシュを更新します。
    *   バックエンドは使用済み（または期限切れ）のリセットトークンを無効化します。
    *   バックエンドは成功レスポンスを返します。
    *   ユーザーはログイン画面にリダイレクトされます。

## 3. 認可（アクセス制御）

### 3.1. 役割（ロール）

*   **グローバルロール (`User.role`):**
    *   `ADMIN`: システム全体の管理者。全てのデータにアクセス可能。
    *   `USER`: 一般ユーザー。基本的な権限を持つ。
*   **プロジェクトロール (`ProjectMember.role`):**
    *   `MANAGER`: 特定プロジェクトの管理者。プロジェクト設定、メンバー管理、質問管理などを行う。
    *   `MEMBER`: 特定プロジェクトのメンバー。プロジェクト内の質問閲覧、回答などを行う。

### 3.2. アクセス制御の実装

*   **APIエンドポイントレベル:**
    *   バックエンドの各APIエンドポイントには、アクセスに必要なロール（グローバルロール、および/またはプロジェクトロール）を定義します。
    *   リクエスト受信時、バックエンドはJWTを検証し、ユーザーIDとグローバルロールを取得します。
    *   プロジェクト関連のエンドポイントでは、さらに `projectId` とユーザーIDを用いて `ProjectMember` テーブルを検索し、プロジェクトロールを確認します。
    *   定義されたロール要件を満たさない場合、`403 Forbidden` エラーを返します。
    *   API設計書 (`api_design.md`) に記載された各エンドポイントの `Authorization` 要件に従います。
*   **UIコンポーネントレベル:**
    *   フロントエンドは、ログインユーザーのロール情報（グローバルロール、および表示中のプロジェクトにおけるプロジェクトロール）を状態管理（Zustand）で保持します。
    *   このロール情報に基づき、特定のボタン（例: 「プロジェクト削除」「ユーザー招待」「質問編集」）やナビゲーションメニュー項目、設定画面セクションなどの表示/非表示、有効/無効を制御します。

### 3.3. 権限の詳細（再掲）

*   **ADMIN:** 全プロジェクト・全質問のCRUD、全ユーザー管理、システム設定。
*   **プロジェクト管理者 (MANAGER):** 担当プロジェクトの設定変更、タグ管理、メンバー招待・除外・役割変更、担当プロジェクト内の全質問のCRUD。
*   **通常ユーザー (USER / MEMBER):**
    *   自身が作成したプロジェクト/質問のCRUD（ただしプロジェクト削除はAdminのみ検討）。
    *   参加プロジェクト内の質問閲覧・回答。
    *   自身の回答の編集・削除。
    *   プロジェクト作成（作成者は自動的にMANAGERになる）。
    *   招待の承認/拒否。

## 4. セキュリティ対策

*   **パスワードハッシング:** bcryptやArgon2などの強力なアダプティブハッシング関数を使用し、ソルトを含めてパスワードを保存します。
*   **JWTセキュリティ:**
    *   HTTPSを強制し、通信経路上でのトークン盗聴を防ぎます。
    *   短い有効期限（例: 15分〜1時間）を設定し、リフレッシュトークンメカニズムを導入するか、セッションベースの認証を検討します（今回はJWTのみの前提）。
    *   `HttpOnly` クッキーを使用してJWTを保存し、XSSによるトークン盗難リスクを軽減します（Next.jsのサーバーサイド機能と連携）。LocalStorage/SessionStorageを使用する場合はXSS対策を徹底します。
    *   署名には強力な秘密鍵を使用し、適切に管理します。
*   **レート制限:** ログイン試行、パスワードリセット要求などにレート制限を設け、ブルートフォース攻撃を防ぎます。
*   **入力検証:** フロントエンドとバックエンドの両方で厳格な入力検証を行い、インジェクション攻撃などを防ぎます。
*   **依存関係の管理:** 使用するライブラリ（認証ライブラリ、JWTライブラリなど）の脆弱性を定期的にチェックし、最新の状態に保ちます。

## 5. 技術選定（再掲）

*   **パスワードハッシングライブラリ:** `bcrypt` (Node.js標準で利用しやすい)
*   **JWTライブラリ:** `jsonwebtoken` (Node.jsで一般的)
*   **認証ミドルウェア:** Next.jsのミドルウェアやAPIルート内でJWT検証とユーザー情報付与を行うカスタムロジック、または `next-auth` のようなライブラリの利用も検討可能ですが、今回はカスタム実装を前提とします。

